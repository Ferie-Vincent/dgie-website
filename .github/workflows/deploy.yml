name: Deploy to Plesk via FTP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, json, bcmath, curl, gd, intl, zip, pdo_mysql
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: Generate .env file
        run: |
          cat > .env << 'ENVEOF'
          APP_NAME="DGIE"
          APP_ENV=production
          APP_DEBUG=false
          APP_TIMEZONE=Africa/Abidjan
          APP_URL=https://ivoiriendelexterieur.com
          APP_KEY=base64:185bn4b5ZriqWhP0Go4g5zobf5ANTthvL1MXyR5AEfs=
          DEPLOY_TOKEN=dgie-deploy-secure-2026

          APP_LOCALE=fr
          APP_FALLBACK_LOCALE=fr
          APP_FAKER_LOCALE=fr_FR
          APP_MAINTENANCE_DRIVER=file

          BCRYPT_ROUNDS=12

          LOG_CHANNEL=single
          LOG_LEVEL=error

          DB_CONNECTION=mysql
          DB_HOST=localhost
          DB_PORT=3306
          DB_DATABASE=db_dgie
          DB_USERNAME=dgie
          DB_PASSWORD=Azertyuiop1234.

          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/

          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=public
          QUEUE_CONNECTION=sync

          CACHE_STORE=file

          MAIL_MAILER=sendmail
          MAIL_FROM_ADDRESS="contact@ivoiriendelexterieur.com"
          MAIL_FROM_NAME="DGIE - Direction Générale des Ivoiriens de l'Extérieur"

          VITE_APP_NAME="${APP_NAME}"
          ENVEOF
          sed -i 's/^[[:space:]]*//' .env

      - name: Install lftp
        run: sudo apt-get install -y lftp

      - name: Deploy via lftp
        run: |
          lftp -e "
            set ssl:verify-certificate no;
            set ftp:ssl-protect-data yes;
            set ftp:passive-mode yes;
            set net:max-retries 3;
            set net:reconnect-interval-base 5;
            open ftp://ivoirien:Azertyuiop1234.@51.15.161.204;
            mirror --reverse --verbose --parallel=5 \
              --exclude ^\.git/ \
              --exclude ^node_modules/ \
              --exclude ^vendor/ \
              --exclude ^tests/ \
              --exclude ^_bmad/ \
              --exclude ^\.env\.example$ \
              --exclude ^\.editorconfig$ \
              --exclude ^\.styleci\.yml$ \
              --exclude ^phpunit\.xml$ \
              --exclude ^CLAUDE\.md$ \
              --exclude ^SPEC-DGIE\.md$ \
              ./ /httpdocs/;
            echo 'Syncing autoloader...';
            mirror --reverse --verbose --parallel=5 \
              vendor/composer/ /httpdocs/vendor/composer/;
            put vendor/autoload.php -o /httpdocs/vendor/autoload.php;
            quit;
          "
